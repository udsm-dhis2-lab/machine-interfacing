<!-- Begin page content -->
<main role="main" class="container-lg">
  <div class="w-100 d-flex justify-content-end">
    <button
      mat-button
      [matMenuTriggerFor]="settingsMenu"
      *ngIf="keyedCurrentPrivileges['ADD_SETTINGS']"
    >
      Settings
    </button>
    <mat-menu #settingsMenu="matMenu">
      <button mat-menu-item routerLink="/settings">General settings</button>
      <button
        mat-menu-item
        routerLink="/functions"
        *ngIf="keyedCurrentPrivileges['ADD_FUNCTION']"
      >
        Functions & Secrets
      </button>
    </mat-menu>

    <button mat-button (click)="logOut($event)" title="Log out">
      <mat-icon>logout</mat-icon>
    </button>
  </div>
  <br />
  <br />
  <br />
  <br />

  <div class="card">
    <div class="card-body">
      <div *ngIf="isConnected; else notConnected">
        <h5 class="card-title text-success">
          <span>{{ machineName }}</span> Connected
        </h5>
        <!-- <p class="card-text">Disconnect to modify settings.</p> -->
        <button (click)="close()" class="btn btn-danger">
          <span>Disconnect {{ machineName }}</span>
        </button>
        <button
          mat-raised-button
          color="primary"
          [style.width]="'120px'"
          class="btn-primary p-1 d-inline-flex justify-content-center align-items-center"
          routerLink="/functions"
        >
          <mat-icon>dashboard</mat-icon>
          <span> Functions </span>
        </button>
      </div>

      <ng-template #notConnected>
        <h5 class="card-title text-danger">
          <span>{{ machineName }}</span> Not Connected!
        </h5>
        <p class="card-text">
          Please try to reconnect and wait for a few moments.
        </p>
        <button
          (click)="reconnect()"
          mat-raised-button
          [style.height]="'38px'"
          [style.width]="reconnectButtonText === 'Connect' ? '100px' : 'auto'"
          [style.background-color]="'#188754'"
          [style.color]="'#FFFFFF'"
          class="btn-primary p-1 d-inline-flex justify-content-center align-items-center"
          [disabled]="connectionInProcess"
        >
          <ng-container *ngIf="reconnectButtonText === 'Connect'">
            <mat-icon>link</mat-icon>
          </ng-container>
          <span>{{ reconnectButtonText }}</span>
        </button>
        &nbsp;&nbsp;

        <button
          (click)="close()"
          *ngIf="connectionInProcess && keyedCurrentPrivileges['ADD_SETTINGS']"
          mat-raised-button
          [style.width]="'100px'"
          [style.height]="'38px'"
          [style.background-color]="'#DC3545'"
          [style.color]="'#FFFFFF'"
          class="btn-primary p-1 d-inline-flex justify-content-center align-items-center"
        >
          <mat-icon>cancel</mat-icon>
          <span> Cancel </span>
        </button>
        &nbsp;&nbsp;
        <button
          *ngIf="!connectionInProcess && keyedCurrentPrivileges['ADD_SETTINGS']"
          mat-raised-button
          [style.width]="'100px'"
          [style.height]="'38px'"
          [style.background-color]="'#0C6EFD'"
          [style.color]="'#FFFFFF'"
          class="btn-primary p-1 d-inline-flex justify-content-center align-items-center"
          routerLink="/settings"
        >
          <mat-icon>settings</mat-icon>
          <span> Settings </span>
        </button>

        &nbsp;&nbsp;
        <button
          *ngIf="keyedCurrentPrivileges['ADD_FUNCTION']"
          mat-raised-button
          color="primary"
          [style.width]="'100px'"
          [style.height]="'38px'"
          class="btn-primary p-1 d-inline-flex justify-content-center align-items-center"
          routerLink="/functions"
        >
          <mat-icon>functions</mat-icon>
          <span> Functions </span>
        </button>
      </ng-template>
    </div>
    <div class="livelog">
      <app-logs [liveLogText]="liveLogText"></app-logs>
    </div>
  </div>

  <div style="padding: 10px; font-size: 0.8em">
    <span style="padding-right: 10px" *ngIf="lastLimsSync"
      ><strong>Last LIS Sync on :</strong> {{ lastLimsSync }}</span
    >
    <span style="padding-right: 10px" *ngIf="lastResultReceived"
      ><strong>Last Instrument Result Received on :</strong>
      {{ lastResultReceived }}</span
    >
    <a
      (click)="clearLiveLog()"
      class="btn btn-outline-primary btn-sm"
      style="float: right"
    >
      <span>Clear Log</span>
    </a>
  </div>

  <br />

  <br />

  <div class="card">
    <div class="card-body">
      <div class="w-100 d-flex justify-content-between">
        <div class="w-25">
          <h4>Recent Results</h4>
        </div>
        <div class="w-75 d-flex justify-content-end">
          <span class="key-info" *ngFor="let status of statusesForKey">
            <span
              ><mat-icon>
                {{ status?.icon }}
              </mat-icon></span
            >
            <span>
              {{ status?.label }}
            </span>
          </span>
          <button
            (click)="fetchLastOrders()"
            class="btn btn-sm btn-primary"
            style="float: right"
          >
            <span>Fetch Recent Records</span>
          </button>
        </div>
      </div>
      <table mat-table [dataSource]="lastOrders" class="mat-elevation-z2 table">
        <!-- Name Column -->
        <ng-container class="text-center" matColumnDef="order_id">
          <th style="width: 15% !important" mat-header-cell *matHeaderCellDef>
            Sample/Order ID
          </th>
          <td mat-cell *matCellDef="let element">{{ element?.order_id }}</td>
        </ng-container>

        <!-- Description Column -->
        <ng-container matColumnDef="results">
          <th style="width: 15%" mat-header-cell *matHeaderCellDef>
            Test Result
          </th>
          <td mat-cell *matCellDef="let element">{{ element?.results }}</td>
        </ng-container>

        <!-- Frequency Column -->
        <ng-container matColumnDef="test_unit">
          <th style="width: 10%" mat-header-cell *matHeaderCellDef>
            Result Unit
          </th>
          <td mat-cell *matCellDef="let element">{{ element?.test_unit }}</td>
        </ng-container>

        <!-- Frequency Column -->
        <ng-container matColumnDef="test_type">
          <th style="width: 15%" mat-header-cell *matHeaderCellDef>
            Test Type
          </th>
          <td mat-cell *matCellDef="let element">{{ element?.test_type }}</td>
        </ng-container>

        <!-- Frequency Column -->
        <ng-container matColumnDef="tested_by">
          <th style="width: 15%" mat-header-cell *matHeaderCellDef>
            Tested By
          </th>
          <td mat-cell *matCellDef="let element">{{ element?.tested_by }}</td>
        </ng-container>

        <!-- Frequency Column -->
        <ng-container matColumnDef="tested_on">
          <th style="width: 10%" mat-header-cell *matHeaderCellDef>
            Tested On
          </th>
          <td mat-cell *matCellDef="let element">
            {{
              (element?.analysed_date_time || "")
                .toString()
                .split("GMT+0300 (East Africa Time)")
                .join(" ")
            }}
          </td>
        </ng-container>

        <!-- Frequency Column -->
        <ng-container matColumnDef="can_sync">
          <th
            class="text-center"
            style="width: 5%"
            mat-header-cell
            *matHeaderCellDef
          >
            Can Sync
          </th>
          <td class="text-center" mat-cell *matCellDef="let element">
            <mat-checkbox
              class="example-margin"
              [disabled]="true"
              [checked]="checkedCanSync(element?.can_sync)"
              color="primary"
              (change)="changeSyncStatus($event.checked, element)"
            >
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Frequency Column -->
        <ng-container matColumnDef="lims_sync_status">
          <th
            class="text-center"
            style="width: 5%"
            mat-header-cell
            *matHeaderCellDef
          >
            Sync Status
          </th>
          <td
            class="text-center"
            mat-cell
            *matCellDef="let element"
            [ngClass]="{
              'fa-spin': statuses[element?.lims_sync_status]?.spin
            }"
          >
            <mat-icon style="font-size: 1rem; margin-top: 6px">{{
              statuses[
                !element?.sync_status
                  ? element?.lims_sync_status
                  : element?.sync_status
              ]?.icon
            }}</mat-icon>
          </td>
        </ng-container>

        <!-- Frequency Column -->
        <ng-container matColumnDef="lims_sync_date_time">
          <th style="width: 5%" mat-header-cell *matHeaderCellDef>
            Sync Datetime
          </th>
          <td mat-cell *matCellDef="let element">
            {{ element?.lims_sync_date_time }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions" lastButton>
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td
            mat-cell
            *matCellDef="let element"
            style="cursor: pointer"
            matRipple
          >
            <button
              mat-icon-button
              [matMenuTriggerFor]="menu"
              [disabled]="
                !keyedCurrentPrivileges['DO_FINAL_AUTHORIZATION'] &&
                !keyedCurrentPrivileges['DO_AUTHORIZE']
              "
              aria-label="More actions"
              (click)="getApprovalInfos($event, element)"
            >
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button
                mat-menu-item
                [disabled]="
                  currentOrderApprovalStatuses?.length >=
                    appSettings.authorizationCount ||
                  (!keyedCurrentPrivileges['DO_FINAL_AUTHORIZATION'] &&
                    !keyedCurrentPrivileges['DO_AUTHORIZE'])
                "
                (click)="onApproval($event, element)"
              >
                <!-- <mat-icon></mat-icon> -->
                <span>{{
                  currentOrderApprovalStatuses?.length == 0
                    ? "Approve"
                    : currentOrderApprovalStatuses?.length == 1
                    ? "Second Approval"
                    : "FULL AUTHORIZED"
                }}</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
      <div class="sticky-paginator">
        <mat-paginator
          #paginator
          [length]="totalRows"
          [pageIndex]="currentPage"
          [pageSize]="pageSize"
          [pageSizeOptions]="pageSizeOptions"
          (page)="pageChanged($event)"
          aria-label="Select page"
          showFirstLastButtons
        >
        </mat-paginator>
      </div>
    </div>
  </div>
  <br />
  <br />
  <br />
  <br />
</main>
